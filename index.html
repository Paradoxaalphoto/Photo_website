<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>YorN — Alpha (CDN Fallback)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@3.21.0/dist/tf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
</head>
<body class="bg-gray-50 text-gray-900">
  <div class="max-w-4xl mx-auto p-4 space-y-4">
    <h1 class="text-2xl font-bold">YorN — Alpha</h1>
    <p class="text-sm text-gray-600">This build auto-falls back to a working CDN for model weights.</p>

    <section class="grid md:grid-cols-[1fr_auto] gap-3 items-end bg-white p-4 rounded-xl shadow">
      <input id="fileInput" type="file" accept="image/*" class="border p-2 rounded w-full" />
      <div class="flex gap-2">
        <button id="analyzeBtn" class="px-4 py-2 bg-blue-600 text-white rounded disabled:opacity-50" disabled>Analyze</button>
      </div>
      <div class="col-span-full w-full bg-gray-200 h-2 rounded overflow-hidden">
        <div id="progressBar" class="bg-blue-600 h-2 w-0"></div>
      </div>
      <div id="progressText" class="col-span-full text-xs text-gray-600"></div>
    </section>

    <section class="grid md:grid-cols-2 gap-4">
      <div class="bg-white p-4 rounded-xl shadow">
        <h2 class="text-sm font-semibold mb-2">Preview</h2>
        <img id="thumb" class="hidden w-full max-h-96 object-contain rounded border bg-white" alt="Selected preview" />
        <canvas id="overlay" class="hidden border rounded bg-white mt-3"></canvas>
      </div>
      <div class="bg-white p-4 rounded-xl shadow">
        <h2 class="text-sm font-semibold mb-2">Diagnostics</h2>
        <div id="diag" class="text-xs whitespace-pre-wrap font-mono bg-gray-50 border rounded p-2 max-h-80 overflow-auto">No diagnostics yet.</div>
        <div id="errorBox" class="text-sm text-red-700 bg-red-50 border border-red-200 rounded p-2 mt-2 hidden"></div>
      </div>
    </section>

    <section class="bg-white p-4 rounded-xl shadow">
      <h2 class="text-sm font-semibold mb-2">Chart</h2>
      <canvas id="scoreChart" class="hidden"></canvas>
    </section>
  </div>

<script>
const CDNS = [
  "https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/weights",
  "https://cdn.jsdelivr.net/gh/justadudewhohacks/face-api.js@0.22.2/weights"
];
let WEIGHTS = null;

const UA = navigator.userAgent;
const isMobile = /Android|iPhone|iPad|iPod/i.test(UA);
let modelsLoaded = false, imageBlobUrl = null, imageEl = null, detectorUsed = null;

const $ = id => document.getElementById(id);
const analyzeBtn = $("analyzeBtn"), fileInput = $("fileInput");
const progressBar = $("progressBar"), progressText = $("progressText");
const thumb = $("thumb"), overlay = $("overlay"), chart = $("scoreChart");
const diag = $("diag"), errorBox = $("errorBox");

function setProgress(p,t){ progressBar.style.width=(p||0)+'%'; progressText.textContent=t||''; }
function logDiag(obj){ const now = new Date().toISOString(); const txt = typeof obj === 'string' ? obj : JSON.stringify(obj,null,2); diag.textContent = `[${now}]\n`+txt+"\n\n"+diag.textContent; }
function setError(msg){ errorBox.textContent=msg; errorBox.classList.remove('hidden'); logDiag({error:msg}); }
function clearError(){ errorBox.textContent=''; errorBox.classList.add('hidden'); }

async function pickWorkingCdn(){
  for(const base of CDNS){
    try{
      const test = base + "/face_landmark_68_model-weights_manifest.json";
      const res = await fetch(test, { method: "HEAD" });
      if(res.ok){ WEIGHTS = base; logDiag({ usingWeightsFrom: base }); return; }
      else { logDiag({ cdnAttempt: base, status: res.status }); }
    }catch(e){ logDiag({ cdnAttempt: base, error: e && e.message }); }
  }
  throw new Error("No working CDN for model weights");
}

fileInput.addEventListener("change", () => {
  if (!fileInput.files.length) { analyzeBtn.disabled = true; return; }
  const file = fileInput.files[0];
  imageBlobUrl = URL.createObjectURL(file);
  thumb.src = imageBlobUrl;
  thumb.classList.remove("hidden");
  analyzeBtn.disabled = false;
  overlay.classList.add("hidden"); chart.classList.add("hidden");
  clearError(); setProgress(0,"");
  logDiag({ fileName: file.name, type: file.type, size_bytes: file.size });
});

analyzeBtn.addEventListener("click", async () => {
  try {
    clearError();
    setProgress(6, "Selecting CDN…");
    if(!WEIGHTS) await pickWorkingCdn();

    setProgress(12, "Loading TFJS…");
    await tf.ready();

    if (isMobile){
      setProgress(25, "Loading TinyFaceDetector…");
      await faceapi.nets.tinyFaceDetector.loadFromUri(WEIGHTS);
      detectorUsed = "TinyFaceDetector";
    } else {
      setProgress(25, "Loading SSD Mobilenet v1…");
      await faceapi.nets.ssdMobilenetv1.loadFromUri(WEIGHTS);
      detectorUsed = "SSD Mobilenet v1";
    }

    setProgress(45, "Loading Landmarks…");
    await faceapi.nets.faceLandmark68Net.loadFromUri(WEIGHTS);

    modelsLoaded = true;
    logDiag({ detectorUsed, modelsLoaded, weightsBase: WEIGHTS });

    if(!imageBlobUrl){ setProgress(0,"Please choose a photo first."); return; }
    setProgress(60, "Preparing image…");
    imageEl = new Image();
    imageEl.onload = async () => {
      const displaySize = { width: imageEl.width, height: imageEl.height };
      overlay.width = imageEl.width; overlay.height = imageEl.height;
      setProgress(74, "Detecting face…");
      let det;
      if (detectorUsed === "TinyFaceDetector"){
        const opts = new faceapi.TinyFaceDetectorOptions({ inputSize: 320, scoreThreshold: 0.5 });
        det = await faceapi.detectSingleFace(imageEl, opts).withFaceLandmarks(true);
      } else {
        det = await faceapi.detectSingleFace(imageEl).withFaceLandmarks();
      }
      if(!det){ setProgress(0,""); setError("No face detected. Try a clearer, front-facing photo."); return; }

      setProgress(86, "Computing metrics…");
      const pts = det.landmarks.positions;
      const dist = (a,b)=> Math.hypot(a.x-b.x, a.y-b.y);
      const fWHR = dist(pts[2],pts[14]) / Math.max(1, dist(pts[27],pts[51]));
      let dev=0,n=0; for(let i=0;i<=8;i++){ const L=pts[i],R=pts[16-i]; dev += Math.abs(L.y-R.y) + Math.abs((L.x+R.x)-pts[8].x*2); n++; }
      const symmetryScore = Math.max(0, 10 - (dev/Math.max(1,n))/10);
      const eyeAvgY = (pts[37].y + pts[44].y)/2, mouthAvgY = (pts[62].y + pts[66].y)/2, chin=pts[8].y, top=pts[27].y;
      const seg1 = Math.abs(mouthAvgY-eyeAvgY), seg2 = Math.abs(chin-top);
      const goldenScore = Math.max(0, 10 - Math.abs(1.618 - (seg2/Math.max(1,seg1))/1.618)*10);
      const aggregate = Number(((symmetryScore + goldenScore + (Math.min(fWHR,2.2)/2.0)*10)/3).toFixed(2));

      // draw overlay
      const ctx = overlay.getContext('2d');
      ctx.clearRect(0,0,overlay.width,overlay.height);
      ctx.drawImage(imageEl,0,0,imageEl.width,imageEl.height);
      const resized = faceapi.resizeResults(det, displaySize);
      faceapi.draw.drawFaceLandmarks(overlay, resized);
      overlay.classList.remove("hidden");

      // chart
      setProgress(92,"Building chart…");
      chart.classList.remove("hidden");
      new Chart(chart, {
        type:'bar',
        data:{ labels:['20-29','30-39','40-49','50-59','60+'],
               datasets:[{ label:'Attractiveness Score', data:[aggregate, aggregate-0.3, aggregate-0.6, aggregate-0.9, aggregate-1.2] }]},
        options:{ responsive:true, scales:{ y:{ beginAtZero:true, max:10 } } }
      });

      setProgress(100,"Done.");
      setTimeout(()=>setProgress(0,""), 1500);
    };
    imageEl.src = imageBlobUrl;

  } catch(e){
    setError("Error during analysis: " + (e && e.message));
    setProgress(0,"");
  }
});
</script>
</body>
</html>
