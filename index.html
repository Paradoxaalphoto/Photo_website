<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>YorN Alpha — 1.10.5 Boot‑Logger</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<!-- ===== BOOT LOGGER SHIM (runs before anything else) ===== -->
<script>
  (function(){
    // Buffer for earliest logs
    window.__yornLogs = [];
    function push(type, payload){
      try{
        const now = new Date().toISOString();
        window.__yornLogs.unshift(`[${now}] ${JSON.stringify({type, ...payload})}\n`);
      }catch(_){}
    }
    // Safe global log the rest of the app can adopt later
    window.__yornBootLog = function(type,payload){ push(type,payload||{}) };

    // Capture super-early errors
    window.addEventListener('error', function(e){
      push('error',{global:e.message, at:(e.filename||'')+':'+(e.lineno||'')});
    });
    window.addEventListener('unhandledrejection', function(e){
      const r = e && e.reason;
      push('error',{unhandled:(r && (r.message||r)) || String(r)});
    });

    // Minimal boot self-test
    push('config', { boot:'starting', ua:navigator.userAgent, ts:Date.now() });
  })();
</script>

<style>
  :root{color-scheme:light dark}
  *{box-sizing:border-box}
  html,body{height:100%}
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;margin:0;background:#0b1220;color:#E6EAF2;overflow-x:hidden}
  .hidden{display:none}
  .container{max-width:980px;margin:0 auto;padding:16px}
  h2{margin:8px 0 0 0}
  .card{background:#0f172a;border:1px solid #233046;border-radius:12px;padding:12px;margin-top:12px}
  .row{display:grid;grid-template-columns:1fr auto auto auto auto auto auto auto auto auto;gap:8px;align-items:end}
  .controls{display:grid;grid-template-columns:repeat(9,1fr);gap:8px;margin-top:8px}
  @media (max-width:720px){
    .row{grid-template-columns:1fr;gap:10px}
    .controls{grid-template-columns:1fr 1fr;gap:10px}
    .two-col{grid-template-columns:1fr;gap:12px}
  }
  label{font-size:12px;color:#A9B4C8}
  input[type="range"],input[type="number"],select{width:100%}
  input[type="number"],input[type="range"],select{padding:6px;border:1px solid #233046;border-radius:8px;background:#0b1220;color:#E6EAF2}
  .chk{display:flex;gap:8px;align-items:center;padding:6px;border:1px solid #233046;border-radius:8px;background:#0b1220}
  button{cursor:pointer}
  .btn{padding:10px 14px;border-radius:8px;border:1px solid #233046;background:#1f2937;color:#E6EAF2}
  .btn[disabled]{opacity:.5;cursor:not-allowed}
  .btn-secondary{background:#0b1220}
  .btn-primary{background:#2563eb}
  #progressContainer{height:8px;background:#1e293b;border-radius:6px;overflow:hidden;margin-top:8px}
  #progressBar{height:100%;width:0;background:#38bdf8;transition:width .25s}
  .previewWrap{position:relative}
  #base,#overlayRough,#overlay{display:block;width:100%;height:auto;margin-top:10px;background:#0b1220;border:1px solid #233046;border-radius:8px}
  #overlayRough,#overlay{position:absolute;left:0;top:0}
  .two-col{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .two-col>div{min-width:0}
  #diagnostics{white-space:pre-wrap;overflow-wrap:anywhere;word-break:break-word;font-family:ui-monospace,Menlo,Consolas,monospace;font-size:12px;background:#0b1220;border:1px solid #233046;border-radius:8px;padding:8px;height:220px;max-height:40vh;overflow:auto}
  .diag-tools{display:flex;gap:8px;align-items:center;margin:6px 0;flex-wrap:wrap}
  .filter-chip{display:inline-flex;gap:6px;align-items:center;padding:4px 8px;border:1px solid #233046;border-radius:999px;background:#0b1220;font-size:12px}
  #revBadge{position:fixed;top:8px;right:10px;z-index:9999;background:rgba(0,0,0,.6);color:#fff;font:12px ui-monospace,monospace;padding:3px 8px;border:1px solid rgba(255,255,255,.18);border-radius:999px}
  #readyBadge{position:fixed;top:36px;right:10px;z-index:9999;display:none;background:rgba(16,185,129,.15);color:#a7f3d0;font:12px ui-monospace,monospace;padding:3px 8px;border:1px solid rgba(16,185,129,.55);border-radius:999px}
  #readyDot{display:inline-block;width:8px;height:8px;border-radius:999px;background:#10b981;margin-right:6px}
  #hud{position:absolute;left:10px;top:16px;z-index:5;display:none;font:12px ui-monospace,monospace;background:rgba(0,0,0,.55);padding:6px 8px;border:1px solid rgba(255,255,255,.18);border-radius:8px}
</style>

<!-- libs (defer to avoid blocking; we’ll check existence before use) -->
<script defer src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@3.21.0/dist/tf.min.js" crossorigin="anonymous"></script>
<script defer src="https://cdn.jsdelivr.net/npm/@tensorflow-models/blazeface@0.0.7/dist/blazeface.min.js" crossorigin="anonymous"></script>
<script defer src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js" crossorigin="anonymous"></script>
</head>
<body>
<div id="revBadge">YorN Rev <span id="revText"></span></div>
<div id="readyBadge"><span id="readyDot"></span><span id="readyText">Ready for Analysis</span></div>

<div class="container">
  <h2>YorN Alpha — Face Detection & Lightweight Analysis</h2>

  <div class="card">
    <div class="row">
      <input id="fileInput" type="file" accept="image/*" />
      <button id="sampleBtn" class="btn btn-secondary">Load Sample</button>
      <button id="pingBtn" class="btn btn-secondary">Ping Log</button>
      <button id="enhanceBtn" class="btn btn-secondary" disabled>Enhance & Retry</button>
      <button id="detectBtn" class="btn" disabled>Detect</button>
      <button id="startAnalysisBtn" class="btn btn-primary" disabled>Start Analysis</button>
      <button id="resetBtn" class="btn btn-secondary">Reset</button>
      <button id="clearLogsBtn" class="btn btn-secondary">Clear Logs</button>
      <button id="copyDiagBtn" class="btn btn-secondary" disabled>Copy Diagnostics</button>
    </div>
    <div id="progressContainer"><div id="progressBar"></div></div>
    <p id="progressText" style="font-size:12px;color:#A9B4C8;margin:6px 2px 0"></p>
  </div>

  <div class="card">
    <div class="two-col">
      <div class="previewWrap">
        <strong style="font-size:13px">Preview</strong>
        <div id="hud"></div>
        <img id="base" class="hidden" alt="Preview base" />
        <canvas id="overlayRough" class="hidden"></canvas>
        <canvas id="overlay" class="hidden"></canvas>
      </div>
      <div>
        <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap">
          <strong style="font-size:13px">Diagnostics</strong>
          <div class="diag-tools">
            <input id="diagSearch" placeholder="filter…" style="padding:6px;border:1px solid #233046;border-radius:8px;background:#0b1220;color:#E6EAF2" />
            <label class="filter-chip"><input type="checkbox" class="diagType" value="detect" checked> detect</label>
            <label class="filter-chip"><input type="checkbox" class="diagType" value="overlay" checked> overlay</label>
            <label class="filter-chip"><input type="checkbox" class="diagType" value="analysis" checked> analysis</label>
            <label class="filter-chip"><input type="checkbox" class="diagType" value="config" checked> config</label>
            <label class="filter-chip"><input type="checkbox" class="diagType" value="error" checked> error</label>
          </div>
        </div>
        <div id="diagnostics">No diagnostics yet.</div>
      </div>
    </div>
  </div>
</div>

<script>
/* ===== constants / elements ===== */
const REVISION="1.10.5-alpha";
document.getElementById("revText").textContent=REVISION;
const $ = id => document.getElementById(id);
const diagnostics=$("diagnostics"), copyDiagBtn=$("copyDiagBtn");
const progressBar=$("progressBar"), progressText=$("progressText");
const imgBase=$("base"), cvRough=$("overlayRough"), cvOverlay=$("overlay");
const fileInput=$("fileInput"), sampleBtn=$("sampleBtn"), pingBtn=$("pingBtn"), detectBtn=$("detectBtn"), startAnalysisBtn=$("startAnalysisBtn");
const enhanceBtn=$("enhanceBtn"), clearLogsBtn=$("clearLogsBtn"), resetBtn=$("resetBtn");

/* ===== adopt boot logger & flush early logs ===== */
function updateDiagCopyBtn(){ copyDiagBtn.disabled = diagnostics.textContent.trim().length===0 || diagnostics.textContent.includes("No diagnostics yet.") }
function appendDiagTop(text){ diagnostics.textContent = text + diagnostics.textContent; updateDiagCopyBtn() }
function logEvt(type,payload){
  const now=new Date().toISOString();
  const line=`[${now}] ${JSON.stringify({type,...(payload||{})})}\n`;
  appendDiagTop(line);
}
(function flushBoot(){
  try{
    if(Array.isArray(window.__yornLogs) && window.__yornLogs.length){
      // Insert boot logs newest-first (already unshifted)
      appendDiagTop(window.__yornLogs.join(""));
      window.__yornLogs.length = 0;
    }
    logEvt('config',{boot:'ui-ready', rev:REVISION});
  }catch(_){}
})();
window.__yornBootLog('config',{boot:'flushed'});

/* ===== global error handlers (post-boot too) ===== */
window.addEventListener('error', e=>{ logEvt('error',{global:e.message,at:(e.filename||'')+':'+(e.lineno||'')}) });
window.addEventListener('unhandledrejection', e=>{ const r=e&&e.reason; logEvt('error',{unhandled:(r&&(r.message||r))||String(r)}) });

/* ===== helpers ===== */
function setProgress(p,t){progressBar.style.width=(p||0)+'%';progressText.textContent=t||''}

/* ===== self test ===== */
(function selfTest(){
  logEvt('config',{selftest:'start', ua:navigator.userAgent});
  // tf presence (scripts are defer; they may not be ready yet)
  setTimeout(async()=>{
    if(!window.tf){ logEvt('error',{tf:'missing (script blocked?)'}) }
    else{
      try{
        await tf.ready();
        const backends=tf.getBackend&&tf.getBackend();
        logEvt('config',{tf:'ready', backend:backends});
      }catch(e){ logEvt('error',{tf_ready:e.message||String(e)}) }
    }
    logEvt('config',{blazeface_present:!!window.blazeface, faceapi_present:!!window.faceapi});
  }, 300);
})();

/* ===== robust image decode ===== */
async function blobToCanvasViaImg(blob){
  const url=URL.createObjectURL(blob);
  try{
    const img=new Image(); img.decoding="sync"; img.loading="eager";
    await new Promise((res,rej)=>{img.onload=res;img.onerror=rej;img.src=url});
    const c=document.createElement("canvas"); c.width=img.naturalWidth; c.height=img.naturalHeight;
    c.getContext("2d").drawImage(img,0,0);
    return c;
  } finally { URL.revokeObjectURL(url) }
}
async function decodeOriginal(fileOrBlob){
  try{
    if('createImageBitmap' in window){
      const bmp=await createImageBitmap(fileOrBlob);
      logEvt('detect',{decode:'createImageBitmap', w:bmp.width, h:bmp.height});
      return {bitmap:bmp, width:bmp.width, height:bmp.height};
    }
  }catch(e){
    logEvt('error',{decode_createImageBitmap:e.message||String(e)});
  }
  const can=await blobToCanvasViaImg(fileOrBlob);
  logEvt('detect',{decode:'img→canvas', w:can.width, h:can.height});
  return {canvas:can, width:can.width, height:can.height};
}

/* ===== preview render ===== */
let baseSource=null; // {bitmap|canvas, width, height}
let workCanvas=null;
function ensureWork(){ if(!workCanvas) workCanvas=document.createElement('canvas'); return workCanvas }
function paintBaseCanvas(canvas){
  try{
    imgBase.src = canvas.toDataURL('image/png');
    imgBase.classList.remove('hidden');
    [cvRough,cvOverlay].forEach(c=>{c.width=canvas.width;c.height=canvas.height;c.classList.remove('hidden')});
    logEvt('overlay',{painted:{w:canvas.width,h:canvas.height}});
  }catch(e){
    logEvt('error',{paint:e.message||String(e)});
  }
}
function renderWorkingCanvas(maxSide=1024){
  if(!baseSource){ logEvt('error',{render:'no baseSource'}); return null; }
  const srcW=baseSource.width, srcH=baseSource.height;
  const scale=Math.min(1, maxSide/Math.max(srcW,srcH));
  const dstW=Math.max(1,Math.round(srcW*scale)), dstH=Math.max(1,Math.round(srcH*scale));
  const c=ensureWork(); c.width=dstW; c.height=dstH;
  const ctx=c.getContext('2d');
  try{
    if(baseSource.bitmap){ ctx.drawImage(baseSource.bitmap,0,0,dstW,dstH); }
    else if(baseSource.canvas){ ctx.drawImage(baseSource.canvas,0,0,dstW,dstH); }
    else { logEvt('error',{render:'unknown source kind'}) }
  }catch(e){ logEvt('error',{render_draw:e.message||String(e)}) }
  return c;
}

/* ===== button wiring ===== */
pingBtn.addEventListener('click',()=>{ logEvt('config',{ping:'pong', ts:Date.now()}) });
copyDiagBtn.addEventListener('click',async()=>{ try{ await navigator.clipboard.writeText(diagnostics.textContent); logEvt('config',{copiedDiagnostics:true}) }catch(e){ logEvt('error',{copyDiagnosticsError:e.message||String(e)}) }});
clearLogsBtn.addEventListener('click',()=>{ diagnostics.textContent='No diagnostics yet.'; updateDiagCopyBtn() });
resetBtn.addEventListener('click',()=>{ baseSource=null; imgBase.classList.add('hidden'); logEvt('config',{reset:true}) });

fileInput.addEventListener('change', async ()=>{
  if(!fileInput.files.length){ return }
  const f=fileInput.files[0];
  setProgress(8,'Decoding photo…');
  try{
    baseSource = await decodeOriginal(f);
    const canvas = renderWorkingCanvas(1024);
    if(canvas){ paintBaseCanvas(canvas); setProgress(12,'Photo ready'); detectBtn.disabled=false; enhanceBtn.disabled=false; }
  }catch(e){
    logEvt('error',{decode_failed:e.message||String(e)});
  }
});

sampleBtn.addEventListener('click', async ()=>{
  try{
    setProgress(5,'Fetching sample…');
    const u="https://images.unsplash.com/photo-1502685104226-ee32379fefbe?q=80&w=1000&auto=format&fit=crop";
    const res=await fetch(u,{cache:"no-store"});
    if(!res.ok) throw new Error('HTTP '+res.status);
    const blob=await res.blob();
    baseSource = await decodeOriginal(blob);
    const canvas=renderWorkingCanvas(1024);
    if(canvas){ paintBaseCanvas(canvas); setProgress(12,'Sample ready'); detectBtn.disabled=false; enhanceBtn.disabled=false; }
    logEvt('detect',{sampleImage:u});
  }catch(e){
    logEvt('error',{sample_failed:e.message||String(e)});
  }
});

/* ===== stubs for detect/analysis (so page runs even before models) ===== */
detectBtn.addEventListener('click', ()=>{
  logEvt('detect',{stub:'detect pressed (models not wired in this minimal boot fix)'});
});
startAnalysisBtn.addEventListener('click', ()=>{
  logEvt('analysis',{stub:'analysis pressed'});
});

/* ===== finalize boot ===== */
logEvt('config',{boot:'complete'});
</script>
</body>
</html>