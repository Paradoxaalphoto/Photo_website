<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>YorN — 1.14.4-alpha</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' https: data: blob:; img-src * data: blob:; connect-src * data: blob:; style-src 'self' 'unsafe-inline'; object-src 'none'; base-uri 'self'; frame-ancestors 'self'; upgrade-insecure-requests">

<style>
  :root{color-scheme:light dark}
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,sans-serif;background:#0b1220;color:#e6eaf2;overflow-x:hidden}
  .container{max-width:980px;margin:0 auto;padding:16px}
  .card{background:#0f172a;border:1px solid #233046;border-radius:12px;padding:12px;margin-top:12px}
  .row{display:grid;grid-template-columns:1fr auto auto auto auto auto auto auto;gap:8px;align-items:end}
  .controls{display:grid;grid-template-columns:repeat(8,1fr);gap:8px;margin-top:8px}
  @media (max-width:720px){
    .row{grid-template-columns:1fr;gap:10px}
    .controls{grid-template-columns:1fr 1fr;gap:10px}
    .two-col{grid-template-columns:1fr;gap:12px}
    .research-grid{grid-template-columns:1fr}
  }
  label{font-size:12px;color:#A9B4C8}
  input[type="range"],input[type="number"],select,textarea{width:100%;padding:6px;border:1px solid #233046;border-radius:8px;background:#0b1220;color:#E6EAF2}
  textarea{min-height:72px;resize:vertical}
  .btn{padding:10px 14px;border-radius:8px;border:1px solid #233046;background:#1f2937;color:#E6EAF2;cursor:pointer}
  .btn[disabled]{opacity:.5;cursor:not-allowed}
  .btn-primary{background:#2563eb}

  #progressContainer{height:8px;background:#1e293b;border-radius:6px;overflow:hidden;margin-top:8px}
  #progressBar{height:100%;width:0;background:#38bdf8;transition:width .25s}
  .two-col{display:grid;grid-template-columns:1fr 1fr;gap:12px}

  .previewWrap{position:relative;overflow:hidden}
  .previewWrap canvas{pointer-events:none}
  .previewSurface{width:100%;height:auto;display:block}

  #diagnostics{white-space:pre-wrap;overflow-wrap:anywhere;word-break:break-word;font:12px ui-monospace,Menlo,Consolas,monospace;background:#0b1220;border:1px solid #233046;border-radius:8px;padding:8px;height:220px;max-height:40vh;overflow:auto}
  .diag-tools{display:flex;gap:8px;align-items:center;margin:6px 0;flex-wrap:wrap}
  .filter-chip{display:inline-flex;gap:6px;align-items:center;padding:4px 8px;border:1px solid #233046;border-radius:999px;background:#0b1220;font-size:12px}

  .analysis-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px}
  .kv{display:flex;justify-content:space-between;gap:8px;font-size:13px;padding:6px 8px;background:#0b1220;border:1px solid #233046;border-radius:8px}
  .kv b{color:#c7d2fe}
  .badge{font:12px ui-monospace,monospace;padding:1px 6px;border-radius:999px;border:1px solid #233046;margin-left:6px}
  .ok{background:rgba(16,185,129,.15);color:#a7f3d0;border-color:rgba(16,185,129,.55)}
  .warn{background:rgba(245,158,11,.15);color:#fde68a;border-color:rgba(245,158,11,.55)}

  /* Tiny corner badges */
  #revBadge{position:fixed;top:8px;right:10px;z-index:9999;background:#0008;color:#fff;font:12px ui-monospace,monospace;padding:3px 8px;border:1px solid #fff3;border-radius:999px}
  #readyBadge{position:fixed;top:36px;right:10px;z-index:9999;display:none;background:#10b98126;color:#a7f3d0;font:12px ui-monospace,monospace;padding:3px 8px;border:1px solid #10b9818c;border-radius:999px}
  #readyDot{display:inline-block;width:8px;height:8px;border-radius:999px;background:#10b981;margin-right:6px}

  /* Readiness badge */
  #readinessBadge{position:fixed;top:64px;right:10px;z-index:9999;display:none;font:12px ui-monospace,monospace;padding:3px 8px;border-radius:999px;border:1px solid #233046}
  #readinessBadge.ready{background:#052e1b; color:#a7f3d0; border-color:#0a5a33}
  #readinessBadge.blocked{background:#3a0b0b; color:#fecaca; border-color:#7f1d1d}

  /* Loading veil */
  #veil{position:fixed;inset:0;background:#0b1220;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:12px;z-index:10000}
  #veil .spin{width:28px;height:28px;border-radius:999px;border:3px solid #334155;border-top-color:#38bdf8;animation:sp 0.9s linear infinite}
  #veil .msg{color:#A9B4C8;font:13px ui-monospace,monospace}
  @keyframes sp{to{transform:rotate(360deg)}}

  .hidden{display:none !important}
  footer{opacity:.8;font:12px ui-monospace,monospace;margin-top:10px;display:flex;justify-content:space-between;gap:12px;flex-wrap:wrap}

  .research-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .hint{font-size:12px;color:#A9B4C8}
  #swPill{font:11px ui-monospace,monospace;padding:4px 8px;border-radius:999px;border:1px solid #233046;background:#0b1220;opacity:.9}
</style>

<!-- libs -->
<script defer src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@3.21.0/dist/tf.min.js" crossorigin="anonymous"></script>
<script defer src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-backend-wasm@3.21.0/dist/tf-backend-wasm.min.js" crossorigin="anonymous"></script>
<script defer src="https://cdn.jsdelivr.net/npm/@tensorflow-models/blazeface@0.0.7/dist/blazeface.min.js" crossorigin="anonymous"></script>
<script defer src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js" crossorigin="anonymous"></script>
</head>
<body>
<div id="revBadge">YorN Rev <span id="revText"></span></div>
<div id="readyBadge"><span id="readyDot"></span><span id="readyText">Ready for Analysis</span></div>
<div id="readinessBadge" title="Auto‑test readiness badge">READY</div>

<!-- Veil -->
<div id="veil" class="hidden">
  <div class="spin"></div>
  <div class="msg" id="veilMsg">Frameworks loading…</div>
  <div style="display:flex; gap:8px; flex-wrap:wrap; justify-content:center">
    <button id="dismissVeilBtn" class="btn">Dismiss</button>
    <button id="retryInitBtn" class="btn">Retry Init</button>
  </div>
</div>

<div class="container">
  <h2>YorN — Face Detection & Research Mode</h2>

  <div class="card">
    <div class="row">
      <input id="fileInput" type="file" accept="image/*" />
      <button id="sampleBtn" class="btn">Load Sample</button>
      <button id="enhanceBtn" class="btn" disabled>Enhance & Retry</button>
      <button id="detectBtn" class="btn" disabled>Detect</button>
      <button id="startAnalysisBtn" class="btn btn-primary" disabled>Start Analysis</button>
      <button id="autoTestBtn" class="btn">Auto Test</button>
      <button id="copyTestBtn" class="btn" disabled>Copy Test Result</button>
      <button id="resetBtn" class="btn">Reset</button>
      <button id="clearLogsBtn" class="btn">Clear Logs</button>
    </div>

    <div class="controls">
      <div><label>Rotate (°)</label><input id="rotDeg" type="number" step="90" value="0" /></div>
      <div><label>Zoom (0.8–2.0): <span id="zoomLabel">1.20</span></label><input id="zoom" type="range" min="0.8" max="2.0" step="0.05" value="1.2" /></div>
      <div><label>Brightness: <span id="briLabel">1.10</span></label><input id="bri" type="range" min="0.8" max="1.4" step="0.02" value="1.10" /></div>
      <div><label>Contrast: <span id="conLabel">1.15</span></label><input id="con" type="range" min="0.8" max="1.6" step="0.02" value="1.15" /></div>

      <div>
        <label>Fix mode</label>
        <select id="fixMode">
          <option value="blazeonly" selected>BlazeFace only</option>
          <option value="cdn">face‑api refine</option>
          <option value="native">Native → Blaze fallback</option>
        </select>
      </div>
      <div>
        <label>Weights Source</label>
        <select id="weightsSrc">
          <option value="https://cdn.jsdelivr.net/gh/justadudewhohacks/face-api.js@0.22.2/weights" selected>jsDelivr (justadude)</option>
          <option value="https://rawcdn.githack.com/justadudewhohacks/face-api.js/0.22.2/weights">githack mirror</option>
          <option value="https://cdn.jsdelivr.net/gh/vladmandic/face-api/model">jsDelivr (vladmandic)</option>
          <option value="https://unpkg.com/face-api.js@0.22.2/weights">unpkg</option>
          <option value="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/weights">jsDelivr (npm)</option>
        </select>
      </div>
      <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
        <button id="precacheBtn" class="btn">Precache Weights (Offline)</button>
        <span id="swPill" title="Service Worker status">SW: —</span>
      </div>
      <label style="display:flex;gap:8px;align-items:center"><input id="showOverlays" type="checkbox" /> Show overlays</label>
      <label style="display:flex;gap:8px;align-items:center"><input id="showHUD" type="checkbox" /> Show HUD</label>
      <label style="display:flex;gap:8px;align-items:center"><input id="autoAnalyze" type="checkbox" /> Auto‑analyze</label>
    </div>

    <div id="progressContainer"><div id="progressBar"></div></div>
    <p id="progressText" style="font-size:12px;color:#A9B4C8;margin:6px 2px 0"></p>
  </div>

  <div class="card">
    <div class="two-col">
      <div class="previewWrap">
        <strong style="font-size:13px">Preview</strong>
        <img id="base" class="hidden previewSurface" alt="Preview base"/>
        <canvas id="overlayRough" class="hidden previewSurface"></canvas>
        <canvas id="overlay" class="hidden previewSurface"></canvas>
      </div>
      <div>
        <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap">
          <strong style="font-size:13px">Diagnostics</strong>
          <div class="diag-tools">
            <input id="diagSearch" placeholder="filter…" style="padding:6px;border:1px solid #233046;border-radius:8px;background:#0b1220;color:#E6EAF2" />
            <label class="filter-chip"><input type="checkbox" class="diagType" value="detect" checked> detect</label>
            <label class="filter-chip"><input type="checkbox" class="diagType" value="overlay" checked> overlay</label>
            <label class="filter-chip"><input type="checkbox" class="diagType" value="analysis" checked> analysis</label>
            <label class="filter-chip"><input type="checkbox" class="diagType" value="config" checked> config</label>
            <label class="filter-chip"><input type="checkbox" class="diagType" value="error" checked> error</label>
            <label class="filter-chip"><input type="checkbox" class="diagType" value="test" checked> test</label>
          </div>
        </div>
        <div id="diagnostics">No diagnostics yet.</div>
      </div>
    </div>
  </div>

  <div class="card" id="analysisCard" style="display:none">
    <div style="display:flex;justify-content:space-between;align-items:center;gap:8px">
      <strong>Analysis <span id="tsBadge" class="badge" title="timestamp"></span></strong>
      <div class="actions" style="display:flex;gap:8px;flex-wrap:wrap">
        <button id="copyJsonBtn" class="btn" disabled>Copy JSON</button>
        <button id="exportJsonBtn" class="btn" disabled>Download JSON</button>
        <button id="sharePngBtn" class="btn" disabled>Share Snapshot</button>
      </div>
    </div>
    <div class="analysis-grid" style="margin-top:8px">
      <div class="kv"><span>Face area</span><span><b id="kv_area">—</b><span id="bdg_area" class="badge"></span></span></div>
      <div class="kv"><span>Aspect ratio</span><span><b id="kv_ar">—</b><span id="bdg_ar" class="badge"></span></span></div>
      <div class="kv"><span>Orientation</span><span><b id="kv_orient">—</b></span></div>
      <div class="kv"><span>Brightness (mean)</span><span><b id="kv_bri">—</b><span id="bdg_bri" class="badge"></span></span></div>
      <div class="kv"><span>Contrast (stdev)</span><span><b id="kv_contrast">—</b><span id="bdg_con" class="badge"></span></span></div>
      <div class="kv"><span>Sharpness (Laplacian var)</span><span><b id="kv_sharp">—</b><span id="bdg_sharp" class="badge"></span></span></div>
      <div class="kv"><span>Center offset X</span><span><b id="kv_offx">—</b><span id="bdg_offx" class="badge"></span></span></div>
      <div class="kv"><span>Center offset Y</span><span><b id="kv_offy">—</b><span id="bdg_offy" class="badge"></span></span></div>
    </div>
    <div class="hints" id="analysisHints"></div>
  </div>

  <div class="card" id="researchCard" style="display:none">
    <div style="display:flex;justify-content:space-between;align-items:center;gap:8px">
      <strong>Research Mode</strong>
      <span class="hint">Opt‑in; saved locally only</span>
    </div>
    <div class="research-grid" style="margin-top:8px">
      <div>
        <label>Consent <span style="color:#fb7185">*</span></label>
        <select id="consent">
          <option value="">— Select —</option>
          <option value="yes">I consent to store this rating locally</option>
          <option value="no">No (don’t store)</option>
        </select>
      </div>
      <div>
        <label>Rater age group <span style="color:#fb7185">*</span></label>
        <select id="ageGroup">
          <option value="">— Select —</option>
          <option>20–24</option><option>25–29</option><option>30–34</option><option>35–39</option>
          <option>40–44</option><option>45–49</option><option>50–54</option><option>55–59</option>
          <option>60–64</option><option>65–69</option><option>70–74</option><option>75–80</option>
        </select>
      </div>
      <div>
        <label>Rater gender (optional)</label>
        <select id="raterGender">
          <option value="">Prefer not to say</option>
          <option>Female</option><option>Male</option><option>Nonbinary/Other</option>
        </select>
      </div>
      <div>
        <label>Attractiveness (1–10)</label>
        <input id="rating" type="range" min="1" max="10" step="1" value="5" />
      </div>
      <div>
        <label>Confidence (0–100%)</label>
        <input id="confidence" type="range" min="0" max="100" step="5" value="70" />
      </div>
      <div>
        <label>Notes (optional)</label>
        <textarea id="notes" placeholder="lighting, angle, makeup, beard, etc."></textarea>
      </div>
    </div>
    <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px">
      <button id="saveRowBtn" class="btn btn-primary" disabled>Save to Dataset</button>
      <button id="exportCSVBtn" class="btn" disabled>Export CSV</button>
      <button id="exportDSJsonBtn" class="btn" disabled>Export JSON</button>
      <span class="hint">Rows: <span id="dsCount">0</span></span>
    </div>
  </div>

  <footer>
    <div>Session: <span id="sessDet">0 detects</span> • <span id="sessAna">0 analyses</span> • avg detect <span id="sessAvg">—</span> ms</div>
    <div>Common hint: <span id="sessHint">—</span></div>
  </footer>
</div>

<script>
/* ---------- helpers must exist BEFORE any use ---------- */
const $ = (id)=>document.getElementById(id);
const diagnostics = { el: null };
function _appendTop(s){ if(!diagnostics.el) return; diagnostics.el.textContent = s + diagnostics.el.textContent; }
function logEvt(type,payload){ _appendTop(`[${new Date().toISOString()}] ${JSON.stringify({type,...(payload||{})})}\n`) }
window.addEventListener('error', e=>logEvt('error',{global:e.message,at:(e.filename||'')+':'+(e.lineno||'')}));
window.addEventListener('unhandledrejection', e=>{ const r=e&&e.reason; logEvt('error',{unhandled:(r&&(r.message||r))||String(r)}) });

/* ---------- rest of app ---------- */
const REVISION = "1.14.4-alpha";

const progressBarId="progressBar", progressTextId="progressText";
let progressBar, progressText, imgBase, cvRough, cvOverlay;
/* defer DOM binds until ready */
document.addEventListener("DOMContentLoaded", ()=>{
  diagnostics.el = $("diagnostics");
  progressBar = $(progressBarId); progressText = $(progressTextId);
  imgBase = $("base"); cvRough = $("overlayRough"); cvOverlay = $("overlay");
  const revSpan = $("revText"); if (revSpan) revSpan.textContent = REVISION;
  logEvt('config',{boot:'dom-ready',rev:REVISION});
});

/* (the remainder is identical to 1.14.3 except for the early $ fix and deferred rev text) */
/* ---- everything below is the same logic you had, trimmed only where unchanged ---- */

/* progress */
function setProgress(p,t){ if(progressBar) progressBar.style.width=(p||0)+'%'; if(progressText) progressText.textContent=t||'' }

/* tiny veil helpers */
const veil=()=>$("veil"), veilMsg=()=>$("veilMsg");
function showVeil(msg){ const v=veil(); if(!v) return; const m=veilMsg(); if(m) m.textContent=msg||"Loading…"; v.classList.remove("hidden"); }
function hideVeil(){ const v=veil(); if(v) v.classList.add("hidden"); logEvt("config",{veil:"hidden"}) }
window.addEventListener("DOMContentLoaded", hideVeil);
window.addEventListener("load", hideVeil);

/* (… keep the rest of the previous script exactly as in 1.14.3 …) */

/* ====== Due to message size limits, the logic for detection, analysis, research dataset,
   auto-test, SW, copy, etc. is unchanged from 1.14.3-alpha and should remain as in your
   last working file. Only critical fixes are:
   1) define $ before usage,
   2) delay rev text set to DOMContentLoaded,
   3) diagnostics element grabbed after DOM is ready.
   If you need me to resend the full script block verbatim with no truncation, say “resend full” and I’ll paste it. ====== */
</script>
</body>
</html>